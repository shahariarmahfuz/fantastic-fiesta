<!DOCTYPE html>
 {% extends 'base.html' %} {# Assuming base.html provides Bootstrap, Font Awesome, and basic layout #}

 {% block title %}Home - File Server{% endblock %}

 {% block head_extra %}
 {# === Add Choices.js CSS === #}
 <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>

 <style>
     /* Improve mobile list item padding */
     .list-group-item {
         padding-left: 0.75rem;
         padding-right: 0.75rem;
     }

     @media (min-width: 768px) {
         .list-group-item {
             padding-left: 1.25rem;
             padding-right: 1.25rem;
         }
     }

     /* Style for action buttons */
     .file-actions .btn {
         padding: 0.25rem 0.5rem;
         font-size: 0.8rem;
     }
     .file-actions .dropdown-toggle::after {
         display: none; /* Hide default dropdown arrow */
     }

     /* Ensure modal forms have adequate spacing */
     .modal-body .form-group {
         margin-bottom: 1rem;
     }

     /* Action icon button styling */
      .action-icon-btn {
         font-size: 1.1rem;
         padding: 0.8rem 1rem;
         margin: 0 0.25rem;
      }
      .action-icon-btn i {
         margin-right: 0.5rem;
      }

     /* Center empty state message */
     .empty-state {
         display: flex;
         flex-direction: column;
         align-items: center;
         justify-content: center;
         min-height: 150px;
     }

     /* Custom file input styling */
     .custom-file-input ~ .custom-file-label::after {
        content: "Browse";
     }
     .custom-file-label {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
     }

     /* --- Choices.js Custom Styling (Optional) --- */
     /* Adjust styling to better match Bootstrap theme if needed */
     .choices {
        margin-bottom: 0; /* Match form-group */
        font-size: 0.875rem; /* Match Bootstrap form control size */
     }
     .choices__inner {
        background-color: #fff; /* Match Bootstrap input background */
        border: 1px solid #ced4da; /* Match Bootstrap input border */
        border-radius: .25rem; /* Match Bootstrap input border-radius */
        padding: .375rem .75rem; /* Match Bootstrap input padding */
        min-height: calc(1.5em + .75rem + 2px); /* Match Bootstrap input height */
     }
     .choices[data-type*="select-one"] .choices__inner {
        padding-bottom: .375rem; /* Fine-tune padding */
     }
     .choices__list--dropdown .choices__item--selectable.is-highlighted {
        background-color: #007bff; /* Match Bootstrap primary color for highlighted option */
        color: white;
     }
     .choices__input {
         font-size: 0.875rem; /* Match font size */
         background-color: #fff !important; /* Ensure input background matches */
         margin-bottom: 0;
     }
     .choices[data-type*="select-one"]::after {
        /* Style the dropdown arrow if needed, e.g., using Bootstrap's caret */
        content: '';
        height: .5em;
        width: .5em;
        border-style: solid;
        border-color: #343a40; /* Arrow color */
        border-width: 0 .15em .15em 0;
        position: absolute;
        right: 1.15em;
        top: 50%;
        transform: translateY(-50%) rotate(45deg);
        margin-top: -.25em; /* Adjust vertical position */
        pointer-events: none; /* Allow clicks to pass through */
     }
      .choices[data-type*="select-one"].is-open::after {
          margin-top: 0; /* Adjust arrow position when open */
          transform: translateY(-50%) rotate(-135deg);
      }

 </style>
 {% endblock %}

 {% block content %}
     {# Action Buttons Section #}
     <div class="row mb-4">
         <div class="col-12 text-center text-md-left">
             <button type="button" class="btn btn-primary action-icon-btn mb-2 mb-md-0" data-toggle="modal" data-target="#uploadFileModal">
                 <i class="fas fa-cloud-upload-alt"></i> Upload File
             </button>
             <button type="button" class="btn btn-outline-secondary action-icon-btn mb-2 mb-md-0" data-toggle="modal" data-target="#createFolderModal">
                 <i class="fas fa-folder-plus"></i> Create Folder
             </button>
         </div>
     </div>
     <hr class="mb-4">

     {# Folder List #}
     <h4 class="text-primary mb-3"><i class="fas fa-folder mr-2"></i> Folders</h4>
     {% if folders %}
         <div class="list-group mb-4 shadow-sm">
             {% for f in folders %}
                 <a href="{{ url_for('view_folder', folder_id=f.id) }}" class="list-group-item list-group-item-action d-flex align-items-center">
                      <span class="file-icon mr-3"><i class="fas fa-folder text-warning fa-lg"></i></span>
                      <span class="file-name flex-grow-1">{{ f.name }}</span>
                 </a>
             {% endfor %}
         </div>
     {% else %}
         <div class="text-center p-4 my-3 bg-light rounded empty-state">
             <i class="fas fa-folder-open fa-2x mb-3 text-muted"></i>
             <p class="text-muted mb-0">No folders created yet.</p>
         </div>
     {% endif %}
     <hr class="mb-4">

     {# Files in the current view (Root or specific folder) #}
      {% if root_files %}
         <ul class="list-group mb-4 shadow-sm">
             {% for file in root_files %}
             <li class="list-group-item d-flex align-items-center">

                  {# Dynamic Icon Logic #}
                  {% set icon_class = 'fa-file-alt' %} {# Default icon #}
                  {% set icon_color = '' %} {# Default color #}
                  {% if file.mime_type %}
                      {# ... (icon logic remains the same as before) ... #}
                      {% if file.mime_type.startswith('image/') %}{% set icon_class = 'fa-file-image' %}
                      {% elif file.mime_type == 'application/pdf' %}{% set icon_class = 'fa-file-pdf' %}{% set icon_color = 'text-danger' %}
                      {% elif file.mime_type.startswith('audio/') %}{% set icon_class = 'fa-file-audio' %}
                      {% elif file.mime_type.startswith('video/') %}{% set icon_class = 'fa-file-video' %}
                      {% elif file.mime_type in ['application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'] %}{% set icon_class = 'fa-file-word' %}{% set icon_color = 'text-info' %}
                      {% elif file.mime_type in ['application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'] %}{% set icon_class = 'fa-file-excel' %}{% set icon_color = 'text-success' %}
                      {% elif file.mime_type in ['application/vnd.ms-powerpoint', 'application/vnd.openxmlformats-officedocument.presentationml.presentation'] %}{% set icon_class = 'fa-file-powerpoint' %}{% set icon_color = 'text-warning' %}
                      {% elif file.mime_type in ['application/zip', 'application/x-rar-compressed', 'application/x-7z-compressed', 'application/gzip', 'application/x-tar'] %}{% set icon_class = 'fa-file-archive' %}{% set icon_color = 'text-secondary' %}
                      {% endif %}
                  {% endif %}
                   <span class="file-icon mr-3"><i class="fas {{ icon_class }} {{ icon_color }} fa-lg"></i></span>

                  {# === UPDATED File details layout (Name above Date) === #}
                  <div class="file-details flex-grow-1 mr-2" style="min-width: 0;">
                      {# File name as link - Bold, block display, truncated #}
                      <a href="{{ url_for('view_file', file_id=file.id) }}" class="file-name text-dark font-weight-bold d-block text-truncate mb-1" title="{{ file.original_filename }}">
                           {{ file.original_filename }}
                      </a>
                       {# File meta data - smaller text, below name #}
                      <div class="file-meta text-muted small">
                           {% if file.upload_time %}
                              <span class="file-date"><i class="far fa-clock mr-1"></i> {{ file.upload_time | datetimeformat }}</span>
                           {% endif %}
                      </div>
                  </div>
                  {# === END UPDATED File details layout === #}


                 {# File actions dropdown - pushed to the right #}
                 <div class="file-actions ml-auto">
                    <div class="dropdown">
                        <button class="btn btn-sm btn-light text-secondary dropdown-toggle" type="button" id="dropdownMenuButton{{ file.id }}" data-toggle="dropdown" aria-expanded="false" aria-label="File options">
                             <i class="fas fa-ellipsis-v"></i>
                        </button>
                         <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuButton{{ file.id }}">
                             <a class="dropdown-item" href="{{ url_for('view_file', file_id=file.id) }}"><i class="fas fa-eye fa-fw mr-2"></i>View</a>
                             <a class="dropdown-item" href="{{ url_for('download_file', file_id=file.id) }}"><i class="fas fa-download fa-fw mr-2"></i>Download</a>
                             <div class="dropdown-divider"></div>
                             <form method="post" action="{{ url_for('create_share_link', file_id=file.id) }}" class="dropdown-item p-0">
                                  <button type="submit" class="btn btn-link text-decoration-none text-body w-100 text-left pl-3"><i class="fas fa-share-alt fa-fw mr-2"></i>Share</button>
                              </form>
                             <button type="button" class="dropdown-item" data-toggle="modal" data-target="#moveModal{{ file.id }}"><i class="fas fa-arrows-alt-v fa-fw mr-2"></i>Move</button>
                             <div class="dropdown-divider"></div>
                              <form method="post" action="{{ url_for('delete_file', file_id=file.id) }}" class="dropdown-item p-0" onsubmit="return confirm('Are you sure you want to move this file to the trash?');">
                                 <button type="submit" class="btn btn-link text-danger text-decoration-none w-100 text-left pl-3"><i class="fas fa-trash-alt fa-fw mr-2"></i>Delete (Trash)</button>
                             </form>
                         </div>
                    </div>
                 </div>{# /file-actions #}
             </li>

             {# --- Move Modal for this file --- #}
             <div class="modal fade" id="moveModal{{ file.id }}" tabindex="-1" aria-labelledby="moveModalLabel{{ file.id }}" aria-hidden="true">
               <div class="modal-dialog modal-dialog-centered modal-sm">
                 <div class="modal-content">
                   <form method="post" action="{{ url_for('move_file', file_id=file.id) }}">
                     <div class="modal-header">
                       <h5 class="modal-title text-primary" id="moveModalLabel{{ file.id }}"><i class="fas fa-arrows-alt-v mr-2"></i> Move File</h5>
                       <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                     </div>
                     <div class="modal-body">
                       <p class="mb-2"><small>File: <strong class="text-truncate d-inline-block" style="max-width: 200px;">{{ file.original_filename }}</strong></small></p>
                       <div class="form-group mb-0">
                           <label for="target_folder_id{{ file.id }}">Move to folder:</label>
                           {# === Select will be replaced by Choices.js === #}
                           <select name="target_folder_id" id="target_folder_id{{ file.id }}" required>
                               {# Options will be dynamically loaded by Choices.js #}
                               {% if not folders %}
                                 <option value="" disabled selected>No folders available</option>
                               {% else %}
                                  <option value="" disabled selected>-- Select folder --</option>
                                  {% for f in folders %}
                                      <option value="{{ f.id }}">{{ f.name }}</option>
                                  {% endfor %}
                               {% endif %}
                           </select>
                       </div>
                     </div>
                     <div class="modal-footer">
                       <button type="button" class="btn btn-secondary btn-sm" data-dismiss="modal">Cancel</button>
                       <button type="submit" class="btn btn-primary btn-sm" {% if not folders %}disabled{% endif %}><i class="fas fa-check mr-1"></i> Move</button>
                     </div>
                   </form>
                 </div>
               </div>
             </div>
             {# --- End Move Modal --- #}

             {% endfor %} {# End file loop #}
         </ul>{# /list-group #}
     {% else %}
         <div class="text-center p-5 my-4 bg-light rounded empty-state">
           <i class="fas fa-box-open fa-3x mb-3 text-muted"></i>
           <p class="lead text-muted">No files found here.</p>
           <p class="text-muted small">Upload files using the button above.</p>
         </div>
     {% endif %} {# End if root_files #}

     {# --- Upload File Modal --- #}
     <div class="modal fade" id="uploadFileModal" tabindex="-1" aria-labelledby="uploadFileModalLabel" aria-hidden="true">
       <div class="modal-dialog modal-dialog-centered">
         <div class="modal-content">
           <form method="post" action="{{ url_for('upload_file') }}" enctype="multipart/form-data">
             <div class="modal-header">
               <h5 class="modal-title text-primary" id="uploadFileModalLabel"><i class="fas fa-cloud-upload-alt mr-2"></i> Upload File</h5>
               <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
             </div>
             <div class="modal-body">
                 <div class="form-group">
                     <label for="file_upload">Select file:</label>
                     <div class="custom-file">
                         <input type="file" class="custom-file-input" name="file_upload" id="file_upload" required>
                         <label class="custom-file-label" for="file_upload">Choose file...</label>
                     </div>
                 </div>
                 <div class="form-group mb-0">
                     <label for="folder_id_modal">Upload to folder:</label>
                     {# === Select will be replaced by Choices.js === #}
                     <select name="folder_id" id="folder_id_modal">
                         {# Options will be dynamically loaded by Choices.js #}
                         <option value="root">-- Main Folder (Root) --</option>
                         {% for f in folders %}
                         <option value="{{ f.id }}">{{ f.name }}</option>
                         {% endfor %}
                     </select>
                 </div>
             </div>
             <div class="modal-footer">
               <button type="button" class="btn btn-secondary btn-sm" data-dismiss="modal">Cancel</button>
               <button type="submit" class="btn btn-primary btn-sm"><i class="fas fa-upload mr-1"></i> Upload</button>
             </div>
           </form>
         </div>
       </div>
     </div>
     {# --- End Upload File Modal --- #}

     {# --- Create Folder Modal --- #}
     <div class="modal fade" id="createFolderModal" tabindex="-1" aria-labelledby="createFolderModalLabel" aria-hidden="true">
       <div class="modal-dialog modal-dialog-centered modal-sm">
         <div class="modal-content">
           <form method="post" action="{{ url_for('create_folder') }}">
             <div class="modal-header">
               <h5 class="modal-title text-primary" id="createFolderModalLabel"><i class="fas fa-folder-plus mr-2"></i> Create Folder</h5>
               <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
             </div>
             <div class="modal-body">
                 <div class="form-group mb-0">
                    <label for="folder_name">Folder Name:</label>
                    <input type="text" class="form-control form-control-sm" name="folder_name" id="folder_name" placeholder="Enter folder name" required>
                 </div>
             </div>
             <div class="modal-footer">
               <button type="button" class="btn btn-secondary btn-sm" data-dismiss="modal">Cancel</button>
               <button type="submit" class="btn btn-primary btn-sm"><i class="fas fa-plus mr-1"></i> Create</button>
             </div>
           </form>
         </div>
       </div>
     </div>
     {# --- End Create Folder Modal --- #}

 {% endblock %}

 {% block scripts %}
 {# === Add Choices.js JS === #}
 <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

 <script>
     // Script to update the custom file input label
     document.addEventListener('DOMContentLoaded', function() {
         const fileInput = document.getElementById('file_upload');
         if (fileInput) {
             fileInput.addEventListener('change', function(event) {
                 const inputFile = event.target;
                 if (inputFile.files.length > 0) {
                    const fileName = inputFile.files[0].name;
                    const nextSibling = inputFile.nextElementSibling;
                    if (nextSibling && nextSibling.classList.contains('custom-file-label')) {
                        nextSibling.innerHTML = fileName;
                    }
                 }
             });
         }

         // Optional: Reset file input label when upload modal is hidden
         const uploadModal = document.getElementById('uploadFileModal');
         if (uploadModal) {
             $('#uploadFileModal').on('hidden.bs.modal', function (e) {
                 const label = $(this).find('.custom-file-label');
                 if (label) {
                    label.html('Choose file...');
                 }
                 // Reset Choices.js select value if needed (optional)
                 const uploadSelect = document.getElementById('folder_id_modal');
                 if (uploadSelect && uploadSelect.choices) {
                     uploadSelect.choices.setValue(['root']); // Reset to root option
                 }
                 // Optionally reset the form fields
                 // $(this).find('form')[0].reset();
             });
         }

          // Reset create folder form when modal is hidden
         const createModal = document.getElementById('createFolderModal');
         if(createModal) {
             $('#createFolderModal').on('hidden.bs.modal', function (e) {
                $(this).find('form')[0].reset();
             });
         }

         // --- Initialize Choices.js for Select elements ---
         const choicesConfig = {
              searchEnabled: false, // Disable search for simple lists
              itemSelectText: '',   // Text shown on option focus/selection
              shouldSort: false,    // Maintain the original order from HTML
              allowHTML: false,     // Prevent HTML injection in options
              // You can add more configuration options here
              // See: https://github.com/Choices-js/Choices
         };

         // Initialize for upload modal select
         const folderSelectModal = document.getElementById('folder_id_modal');
         if (folderSelectModal) {
             // Store the Choices instance on the element itself for potential later access
             folderSelectModal.choices = new Choices(folderSelectModal, choicesConfig);
         }

         // Initialize for each move modal select
         // Query all select elements whose ID starts with 'target_folder_id'
         const moveSelects = document.querySelectorAll('select[id^="target_folder_id"]');
         moveSelects.forEach(function(selectElement) {
             // Store the Choices instance on each element
             selectElement.choices = new Choices(selectElement, choicesConfig);
         });

         // --- End Choices.js initialization ---

     }); // End DOMContentLoaded

 </script>
 {% endblock %}
