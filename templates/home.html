<!DOCTYPE html>
{% extends 'base.html' %}

{% block title %}Home - File Server{% endblock %}

{% block head_extra %}
<style>
    :root {
        --primary-color: #007bff; /* অথবা আপনার পছন্দের প্রাইমারি রঙ */
        --secondary-color: #6c757d;
        --light-gray: #f8f9fa;
        --border-color: #dee2e6;
        --text-dark: #343a40;
        --text-muted: #6c757d;
        --hover-bg: #e9ecef;
        --success-color: #28a745;
        --danger-color: #dc3545;
        --shadow-sm: 0 .125rem .25rem rgba(0, 0, 0, .075);
        --shadow: 0 .5rem 1rem rgba(0, 0, 0, .15);
        --border-radius: .375rem;
    }

    body {
        background-color: var(--light-gray);
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        font-size: 14px; /* Slightly smaller base font size */
    }

    .container {
        padding-top: 1.5rem; /* Reduced padding */
        padding-bottom: 3rem;
    }

    /* --- Action Buttons --- */
    .action-bar {
        margin-bottom: 1.5rem; /* Reduced margin */
        padding: 0.8rem;
        background-color: #ffffff;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-sm);
        display: flex;
        flex-wrap: wrap;
        gap: 0.6rem;
        align-items: center;
    }
    .action-icon-btn {
        font-size: 0.9rem; /* Adjusted font size */
        padding: 0.5rem 0.9rem;
        border-radius: var(--border-radius);
        transition: all 0.2s ease-in-out;
    }
    .action-icon-btn i {
        margin-right: 0.5rem;
        font-size: 1.1em;
        vertical-align: middle;
    }
    .action-icon-btn:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-sm);
    }
    .btn-primary.action-icon-btn {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }
    .btn-outline-secondary.action-icon-btn {
        border-color: var(--border-color);
        color: var(--secondary-color);
    }
    .btn-outline-secondary.action-icon-btn:hover {
        background-color: var(--secondary-color);
        color: #fff;
    }

    /* --- Section Headers --- */
    .section-header {
        color: var(--text-dark);
        margin-bottom: 0.8rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 1.15rem; /* Adjusted font size */
    }
    .section-header i {
        color: var(--primary-color);
        font-size: 1.1em;
    }

    /* --- General List Styling --- */
    .list-group {
        border: none;
        border-radius: var(--border-radius);
        overflow: hidden;
        box-shadow: var(--shadow-sm);
    }
    .list-group-item {
        padding: 0.8rem 1rem; /* Reduced padding */
        background-color: #ffffff;
        border: 1px solid var(--border-color);
        border-width: 0 0 1px 0;
        transition: background-color 0.15s ease-in-out;
        margin-bottom: 0;
    }
    .list-group-item:first-child {
        border-top-left-radius: var(--border-radius);
        border-top-right-radius: var(--border-radius);
    }
    .list-group-item:last-child {
        border-bottom: none;
        border-bottom-left-radius: var(--border-radius);
        border-bottom-right-radius: var(--border-radius);
    }
    .list-group-item-action:hover,
    .list-group-item-action:focus {
        background-color: var(--hover-bg);
        z-index: 1;
    }

    /* --- Folder & File Item Layout --- */
    .item-layout {
        display: flex;
        align-items: center; /* Align icon and action menu vertically centered */
        width: 100%;
        gap: 0.8rem; /* Adjusted gap */
    }
    .item-icon-container {
        flex-shrink: 0;
        font-size: 1.4rem; /* Adjusted icon size */
        width: 1.8rem; /* Adjusted width */
        text-align: center;
        color: var(--secondary-color); /* Default icon color */
    }
    .item-content {
        flex-grow: 1;
        min-width: 0; /* Crucial for text overflow */
        padding-right: 5px; /* Space before action button */
    }

    /* Name and Meta layout: Stacked */
    .item-name {
        display: block; /* Ensure block display */
        font-weight: 500; /* Slightly less bold */
        color: var(--text-dark);
        font-size: 0.9rem; /* Adjusted font size */
        text-decoration: none;
        transition: color 0.15s ease;

        /* Text Truncation for long names */
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
     .item-name:hover {
        color: var(--primary-color);
        text-decoration: none; /* No underline on hover for cleaner look */
    }
    .item-meta {
        display: block; /* Ensure block display below name */
        font-size: 0.75rem; /* Adjusted font size */
        color: var(--text-muted);
        white-space: nowrap;
        margin-top: 0.15rem; /* Space between name and meta */
    }
    .item-meta i {
        margin-right: 0.3rem;
        font-size: 0.9em; /* Slightly smaller meta icons */
    }
    .item-actions {
        margin-left: auto;
        flex-shrink: 0;
        position: relative;
    }

    /* --- Specific Folder Styles --- */
    .folder-item .item-content {
         /* Folders usually don't have meta, align name centrally if needed */
         display: flex;
         align-items: center; /* Vertically center folder name if no meta */
    }
    .folder-icon {
        color: #ffc107;
    }

    /* --- Specific File Styles --- */
    .file-item .item-icon-container .text-danger { color: #dc3545 !important; }
    .file-item .item-icon-container .text-info { color: #17a2b8 !important; }
    .file-item .item-icon-container .text-success { color: #28a745 !important; }
    .file-item .item-icon-container .text-warning { color: #ffc107 !important; }
    .file-item .item-icon-container .text-secondary { color: #6c757d !important; }
    .file-item .item-icon-container .fa-file-image { color: #a06ee8; }
    .file-item .item-icon-container .fa-file-audio { color: #fd7e14; }
    .file-item .item-icon-container .fa-file-video { color: #e83e8c; }

    /* --- File Action Dropdown --- */
    .item-actions .dropdown-toggle {
        background: none;
        border: none;
        color: var(--secondary-color);
        padding: 0.25rem 0.4rem; /* Adjusted padding */
        font-size: 1rem; /* Adjusted icon size */
        line-height: 1; /* Ensure consistent height */
    }
    .item-actions .dropdown-toggle::after { display: none; }
    .item-actions .dropdown-toggle:hover,
    .item-actions .dropdown-toggle:focus {
        background-color: var(--hover-bg);
        color: var(--text-dark);
        border-radius: var(--border-radius); /* Add radius on hover */
    }
    .dropdown-menu {
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        border: 1px solid rgba(0,0,0,.08);
        padding: 0.4rem 0; /* Adjusted padding */
        font-size: 0.85rem; /* Smaller font in dropdown */
    }
    .dropdown-item {
        font-size: inherit; /* Inherit from dropdown-menu */
        padding: 0.4rem 1rem; /* Adjusted padding */
        color: var(--text-dark);
        display: flex;
        align-items: center;
    }
    .dropdown-item i.fa-fw {
        margin-right: 0.6rem;
        color: var(--text-muted);
        width: 1.2em;
        text-align: center;
    }
     .dropdown-item:hover, .dropdown-item:focus { background-color: var(--hover-bg); color: var(--text-dark); }
     .dropdown-item:active { background-color: var(--primary-color); color: #fff; }
     .dropdown-item:active i.fa-fw { color: #fff; }
     .dropdown-divider { margin: 0.4rem 0; border-top: 1px solid var(--border-color); }
     .dropdown-item form { padding: 0; margin: 0; }
     .dropdown-item form button {
        font-size: inherit;
        padding: 0.4rem 1rem;
        color: var(--text-dark);
        text-align: left !important;
        width: 100%;
        display: flex;
        align-items: center;
        background: none;
        border: none;
    }
     .dropdown-item form button:hover, .dropdown-item form button:focus { background-color: var(--hover-bg); color: var(--text-dark); }
     .dropdown-item form button.text-danger { color: var(--danger-color) !important; }
     .dropdown-item form button.text-danger:hover, .dropdown-item form button.text-danger:focus { background-color: var(--danger-color); color: #fff !important; }
     .dropdown-item form button.text-danger:hover i.fa-fw, .dropdown-item form button.text-danger:focus i.fa-fw { color: #fff; }

    /* --- Empty State --- */
    .empty-state {
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        min-height: 120px; padding: 1.5rem; margin-top: 1rem;
        background-color: #ffffff; border-radius: var(--border-radius);
        border: 1px dashed var(--border-color); text-align: center; color: var(--text-muted);
    }
    .empty-state i { font-size: 2.5rem; margin-bottom: 0.8rem; color: var(--secondary-color); }
    .empty-state p { margin-bottom: 0.25rem; }
    .empty-state .lead { font-size: 1rem; font-weight: 400; color: var(--text-dark); }
    .empty-state .small { font-size: 0.85rem; }

    /* --- Modal Styles --- */
    .modal-content { border-radius: var(--border-radius); border: none; box-shadow: var(--shadow); }
    .modal-header { background-color: var(--light-gray); border-bottom: 1px solid var(--border-color); padding: 0.8rem 1.2rem; }
    .modal-title { font-weight: 600; font-size: 1.05rem; color: var(--primary-color); display: flex; align-items: center; gap: 0.5rem; }
    .modal-body { padding: 1.2rem; }
    .modal-footer { background-color: var(--light-gray); border-top: 1px solid var(--border-color); padding: 0.6rem 1.2rem; }
    .modal-body .form-group { margin-bottom: 1rem; }
    .modal-body label { font-weight: 500; margin-bottom: 0.4rem; font-size: 0.85rem; color: var(--text-dark); }
    .form-control, .custom-select, .custom-file-input, .custom-file-label { border-radius: var(--border-radius); font-size: 0.9rem; border-color: var(--border-color); }
    .form-control:focus, .custom-select:focus, .custom-file-input:focus ~ .custom-file-label { border-color: var(--primary-color); box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, .25); }
    .custom-file-label { background-color: #fff; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; padding-right: 6rem; }
    .custom-file-input:lang(en)~.custom-file-label::after { content: "Browse"; border-radius: 0 var(--border-radius) var(--border-radius) 0; background-color: var(--light-gray); border-left: 1px solid var(--border-color); color: var(--text-dark); }
    .modal-footer .btn { font-size: 0.85rem; padding: 0.4rem 0.8rem; min-width: 70px; }
    .modal-footer .btn i { margin-right: 0.4rem; }

    /* --- Upload Progress --- */
    .upload-progress-container {
        margin-top: 0.8rem;
        display: none; /* Hidden by default */
    }
    .progress {
        height: 8px; /* Slightly thicker progress bar */
        border-radius: 4px;
        background-color: var(--hover-bg);
        overflow: hidden; /* Ensure inner bar respects radius */
    }
    .progress-bar {
        background-color: var(--primary-color);
        transition: width 0.3s ease-out; /* Smooth progress transition */
        /* Optional: Add subtle animation */
        background-image: linear-gradient(45deg, rgba(255, 255, 255, .15) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, .15) 50%, rgba(255, 255, 255, .15) 75%, transparent 75%, transparent);
        background-size: 1rem 1rem;
        animation: progress-bar-stripes 1s linear infinite;
    }
    @keyframes progress-bar-stripes {
        from { background-position: 1rem 0; }
        to { background-position: 0 0; }
    }
    .upload-progress-text {
        font-size: 0.8rem;
        color: var(--text-muted);
        text-align: right;
        margin-top: 0.3rem;
    }
    /* Style for upload complete/error messages */
    .upload-status-message {
        font-size: 0.85rem;
        margin-top: 0.5rem;
        font-weight: 500;
    }
    .upload-status-message.text-success { color: var(--success-color); }
    .upload-status-message.text-danger { color: var(--danger-color); }


    /* --- Mobile Responsive Enhancements --- */
    @media (max-width: 768px) {
        body { font-size: 13px; }
        .container { padding-top: 1rem; padding-bottom: 2rem; }
        .action-bar { padding: 0.6rem; justify-content: center; }
        .action-icon-btn { flex-grow: 1; text-align: center; font-size: 0.85rem; padding: 0.5rem 0.7rem; }
        .list-group-item { padding: 0.6rem 0.8rem; }
        .item-layout {
            align-items: flex-start; /* Align icon to top */
            gap: 0.6rem;
             position: relative; /* Needed for absolute positioning of actions */
             padding-bottom: 2rem; /* Add padding at bottom to make space for actions */
        }
        .item-icon-container { font-size: 1.3rem; width: 1.6rem; margin-top: 0; /* Align with first line of text */ }
        .item-content {
            padding-right: 0; /* No padding needed on mobile */
             /* Takes full width below icon, adjusted for icon width + gap */
             width: calc(100% - 1.6rem - 0.6rem);
             position: static; /* Override any flex positioning */
        }
        .item-name { font-size: 0.85rem; /* Smaller name */ }
        .item-meta { font-size: 0.7rem; /* Smaller meta */ }

        /* Mobile Action Menu Positioning: Position absolutely at the bottom right */
        .item-actions {
             position: absolute;
             bottom: 0.4rem; /* Position near bottom padding */
             right: 0; /* Align to the right edge of the list item */
             margin-left: 0;
             width: auto; /* Let it size based on content */
             margin-top: 0;
             padding-left: 0;
        }
        .item-actions .dropdown-toggle { padding: 0.4rem; }
        .dropdown-menu { /* Ensure menu opens correctly */
             position: absolute !important; /* Override Bootstrap if needed */
             transform: translate3d(-110px, -10px, 0px) !important; /* Adjust based on testing */
        }

        .section-header { font-size: 1.1rem; margin-bottom: 0.6rem; }
        .empty-state { padding: 1.2rem; min-height: 100px; }
        .empty-state i { font-size: 2.2rem; }
        .modal-dialog { margin: 0.5rem; }
        .modal-body { padding: 1rem; }
        .modal-footer { padding: 0.6rem 1rem; }
        .modal-body label { font-size: 0.8rem; }
        .form-control, .custom-select, .custom-file-label { font-size: 0.85rem; }
    }

    @media (max-width: 480px) {
        .action-icon-btn { font-size: 0.8rem; padding: 0.4rem 0.6rem; }
        .action-icon-btn i { margin-right: 0.3rem; }
        .item-layout { padding-bottom: 1.8rem; } /* Adjust space for actions */
        .item-actions { bottom: 0.3rem; }
    }

</style>
{% endblock %}

{% block content %}
    <div class="action-bar shadow-sm">
        <button type="button" class="btn btn-primary action-icon-btn" data-toggle="modal" data-target="#uploadFileModal">
            <i class="fas fa-cloud-upload-alt"></i> Upload File
        </button>
        <button type="button" class="btn btn-outline-secondary action-icon-btn" data-toggle="modal" data-target="#createFolderModal">
            <i class="fas fa-folder-plus"></i> Create Folder
        </button>
    </div>

    <h4 class="section-header"><i class="fas fa-folder"></i> Folders</h4>
    {% if folders %}
        <div class="list-group mb-3"> {# Reduced bottom margin #}
            {% for folder in folders %}
                <a href="{{ url_for('view_folder', folder_id=folder.id) }}" class="list-group-item list-group-item-action">
                    <div class="item-layout folder-item">
                        <div class="item-icon-container">
                            <i class="fas fa-folder folder-icon"></i>
                        </div>
                        <div class="item-content">
                            <span class="item-name" title="{{ folder.name }}">{{ folder.name }}</span> {# Added title for potential overflow #}
                        </div>
                        </div>
                </a>
            {% endfor %}
        </div>
    {% else %}
        <div class="empty-state mb-3">
            <i class="fas fa-folder-open"></i>
            <p class="lead">No folders here yet.</p>
            <p class="small">Use the 'Create Folder' button above.</p>
        </div>
    {% endif %}

    <h4 class="section-header"><i class="fas fa-file-alt"></i> Files</h4>
    {% if root_files %}
        <ul class="list-group mb-4">
            {% for file in root_files %}
            <li class="list-group-item">
                <div class="item-layout file-item">
                    <div class="item-icon-container">
                        {% set icon_class = 'fa-file-alt' %}
                        {# Color classes are added based on type, CSS targets them #}
                        {% if file.mime_type %}
                            {% if file.mime_type.startswith('image/') %} {% set icon_class = 'fa-file-image' %}
                            {% elif file.mime_type == 'application/pdf' %} {% set icon_class = 'fa-file-pdf text-danger' %}
                            {% elif file.mime_type.startswith('audio/') %} {% set icon_class = 'fa-file-audio' %}
                            {% elif file.mime_type.startswith('video/') %} {% set icon_class = 'fa-file-video' %}
                            {% elif file.mime_type in ['application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'] %} {% set icon_class = 'fa-file-word text-info' %}
                            {% elif file.mime_type in ['application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'] %} {% set icon_class = 'fa-file-excel text-success' %}
                            {% elif file.mime_type in ['application/vnd.ms-powerpoint', 'application/vnd.openxmlformats-officedocument.presentationml.presentation'] %} {% set icon_class = 'fa-file-powerpoint text-warning' %}
                            {% elif file.mime_type in ['application/zip', 'application/x-rar-compressed', 'application/x-7z-compressed', 'application/gzip', 'application/x-tar'] %} {% set icon_class = 'fa-file-archive text-secondary' %}
                            {% endif %}
                        {% endif %}
                        <i class="fas {{ icon_class }}"></i>
                    </div>

                    <div class="item-content">
                        {# File name - now handles overflow #}
                        <a href="{{ url_for('view_file', file_id=file.id) }}" class="item-name" title="{{ file.original_filename }}">
                            {{ file.original_filename }}
                        </a>
                        {# Meta info - now below the name #}
                        <span class="item-meta">
                            <i class="far fa-clock"></i> {{ file.upload_time | datetimeformat }}
                             {% if file.size %}
                             <span class="mx-1">|</span> <i class="fas fa-database"></i> {# Changed icon #} {{ file.size | humansize }} {# Requires 'humansize' filter #}
                             {% endif %}
                        </span>
                    </div>

                    <div class="item-actions">
                        <div class="dropdown">
                            <button class="btn btn-sm dropdown-toggle"
                                    type="button"
                                    id="dropdownMenuButton{{ file.id }}"
                                    data-toggle="dropdown"
                                    aria-expanded="false"
                                    title="More actions">
                                <i class="fas fa-ellipsis-v"></i> {# Vertical ellipsis often preferred #}
                            </button>
                            <div class="dropdown-menu dropdown-menu-right"
                                 aria-labelledby="dropdownMenuButton{{ file.id }}">
                                <a class="dropdown-item" href="{{ url_for('view_file', file_id=file.id) }}">
                                    <i class="fas fa-eye fa-fw"></i>View
                                </a>
                                <a class="dropdown-item" href="{{ url_for('download_file', file_id=file.id) }}">
                                    <i class="fas fa-download fa-fw"></i>Download
                                </a>
                                <div class="dropdown-divider"></div>
                                <form method="post" action="{{ url_for('create_share_link', file_id=file.id) }}" class="m-0">
                                    <button type="submit" class="dropdown-item btn btn-link w-100 text-left p-0 border-0">
                                        <i class="fas fa-share-alt fa-fw"></i>Share
                                    </button>
                                </form>
                                <button type="button" class="dropdown-item"
                                        data-toggle="modal"
                                        data-target="#moveModal{{ file.id }}">
                                    <i class="fas fa-folder-open fa-fw"></i>Move
                                </button>
                                <div class="dropdown-divider"></div>
                                <form method="post"
                                      action="{{ url_for('delete_file', file_id=file.id) }}"
                                      class="m-0"
                                      onsubmit="return confirm('Are you sure you want to delete \'{{ file.original_filename }}\'?');">
                                    <button type="submit" class="dropdown-item btn btn-link w-100 text-left p-0 border-0 text-danger">
                                        <i class="fas fa-trash-alt fa-fw"></i>Delete
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </li>

            <div class="modal fade" id="moveModal{{ file.id }}" tabindex="-1"
                 aria-labelledby="moveModalLabel{{ file.id }}" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered modal-sm">
                    <div class="modal-content">
                        <form method="post" action="{{ url_for('move_file', file_id=file.id) }}">
                            <div class="modal-header">
                                <h5 class="modal-title" id="moveModalLabel{{ file.id }}">
                                    <i class="fas fa-folder-open"></i> Move File
                                </h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <p class="mb-2 text-muted small">
                                    Move "<strong>{{ file.original_filename | truncate(30) }}</strong>" to: {# Truncate name in modal too #}
                                </p>
                                <div class="form-group mb-0">
                                    <select name="target_folder_id" id="target_folder_id{{ file.id }}"
                                            class="form-control custom-select" required>
                                        {% if not folders %}
                                            <option value="" disabled selected>No folders available</option>
                                        {% else %}
                                            <option value="" disabled selected>-- Select a folder --</option>
                                            {% for folder in folders %}
                                                <option value="{{ folder.id }}">{{ folder.name }}</option>
                                            {% endfor %}
                                        {% endif %}
                                    </select>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                                <button type="submit" class="btn btn-primary" {% if not folders %}disabled{% endif %}>
                                    <i class="fas fa-check"></i> Move
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            {% endfor %}
        </ul>
    {% else %}
        <div class="empty-state mb-4">
            <i class="fas fa-box-open"></i>
            <p class="lead">No files found here.</p>
            <p class="small">Use the 'Upload File' button to add files.</p>
        </div>
    {% endif %}

    <div class="modal fade" id="uploadFileModal" tabindex="-1"
         aria-labelledby="uploadFileModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false"> {# Prevent closing during upload #}
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <form method="post" action="{{ url_for('upload_file') }}" enctype="multipart/form-data" id="uploadForm">
                    <div class="modal-header">
                        <h5 class="modal-title" id="uploadFileModalLabel">
                            <i class="fas fa-cloud-upload-alt"></i> Upload File
                        </h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close" id="uploadModalCloseButton">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="file_upload">Select file to upload:</label>
                            <div class="custom-file">
                                <input type="file" class="custom-file-input" name="file_upload" id="file_upload" required>
                                <label class="custom-file-label" for="file_upload" data-browse="Browse">Choose file...</label>
                            </div>
                             <div class="upload-progress-container mt-3">
                                 <div class="progress">
                                   <div class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                 </div>
                                 <div class="upload-progress-text text-right mt-1">0%</div>
                                 <div class="upload-status-message mt-2"></div> {# For success/error messages #}
                             </div>
                        </div>
                        <div class="form-group mb-0">
                            <label for="folder_id_modal">Upload to folder:</label>
                            <select name="folder_id" id="folder_id_modal" class="form-control custom-select">
                                <option value="root">-- Main Folder (Root) --</option>
                                {% for folder in folders %}
                                    <option value="{{ folder.id }}">{{ folder.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal" id="uploadCancelButton">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="uploadSubmitButton">
                            <i class="fas fa-upload"></i> Upload
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="createFolderModal" tabindex="-1"
         aria-labelledby="createFolderModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content">
                <form method="post" action="{{ url_for('create_folder') }}" id="createFolderForm">
                    <div class="modal-header">
                        <h5 class="modal-title" id="createFolderModalLabel">
                            <i class="fas fa-folder-plus"></i> Create New Folder
                        </h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group mb-0">
                            <label for="folder_name">Folder Name:</label>
                            <input type="text" class="form-control"
                                   name="folder_name" id="folder_name"
                                   placeholder="Enter folder name" required pattern=".*\S+.*" title="Folder name cannot be empty or just spaces.">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-check"></i> Create
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
{{ super() }} {# Include scripts from base.html if any #}
<script>
$(document).ready(function() {
    // Update custom file input label
    $('#file_upload').on('change', function(event) {
        var inputFile = event.target;
        var fileName = inputFile.files.length > 0 ? inputFile.files[0].name : 'Choose file...';
        $(inputFile).next('.custom-file-label').text(fileName);
        // Reset progress/status if a new file is chosen after a previous attempt
        resetUploadState();
    });

    // Reset upload form state
    function resetUploadState() {
        var modal = $('#uploadFileModal');
        modal.find('.upload-progress-container').hide();
        modal.find('.progress-bar').css('width', '0%').attr('aria-valuenow', 0).removeClass('bg-success bg-danger').addClass('bg-primary');
        modal.find('.upload-progress-text').text('0%');
        modal.find('.upload-status-message').text('').removeClass('text-success text-danger');
        modal.find('#file_upload').prop('disabled', false);
        modal.find('#folder_id_modal').prop('disabled', false);
        modal.find('#uploadSubmitButton').prop('disabled', false).html('<i class="fas fa-upload"></i> Upload');
        modal.find('#uploadCancelButton').prop('disabled', false);
        modal.find('#uploadModalCloseButton').prop('disabled', false);
         // Make modal closable again
        modal.data('bs.modal')._config.backdrop = true;
        modal.data('bs.modal')._config.keyboard = true;
    }

    // Reset forms when modals are closed
    $('#uploadFileModal').on('hidden.bs.modal', function (e) {
        var form = $(this).find('form')[0];
        if (form) form.reset();
        $(this).find('.custom-file-label').text('Choose file...');
        resetUploadState(); // Ensure progress is reset if closed manually
    });

    $('#createFolderModal').on('hidden.bs.modal', function (e) {
         var form = $(this).find('form')[0];
         if (form) form.reset();
    });

    // Prevent empty folder name submission
    $('#createFolderForm').on('submit', function(e) {
        var folderNameInput = $('#folder_name');
        if (folderNameInput.val().trim() === '') {
            alert('Folder name cannot be empty or just spaces.');
            folderNameInput.focus();
            e.preventDefault();
            return false;
        }
    });

    // AJAX File Upload Logic
    $('#uploadForm').on('submit', function(e) {
        e.preventDefault(); // Prevent default form submission

        var form = this;
        var formData = new FormData(form);
        var modal = $('#uploadFileModal');
        var progressBarContainer = modal.find('.upload-progress-container');
        var progressBar = modal.find('.progress-bar');
        var progressText = modal.find('.upload-progress-text');
        var statusMessage = modal.find('.upload-status-message');
        var submitButton = modal.find('#uploadSubmitButton');
        var cancelButton = modal.find('#uploadCancelButton');
        var closeButton = modal.find('#uploadModalCloseButton');
        var fileInput = modal.find('#file_upload');
        var folderSelect = modal.find('#folder_id_modal');

        // Basic check if a file is selected
        if (!fileInput[0].files || fileInput[0].files.length === 0) {
            statusMessage.text('Please select a file first.').addClass('text-danger');
            return;
        }

        // --- Start Upload ---
        progressBarContainer.show();
        statusMessage.text('Uploading...').removeClass('text-success text-danger');
        submitButton.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Uploading...');
        cancelButton.prop('disabled', true); // Disable cancel during upload for simplicity
        closeButton.prop('disabled', true); // Disable close button
        fileInput.prop('disabled', true);
        folderSelect.prop('disabled', true);

        // Prevent closing modal during upload
        modal.data('bs.modal')._config.backdrop = 'static';
        modal.data('bs.modal')._config.keyboard = false;


        $.ajax({
            url: $(form).attr('action'), // Get URL from form action
            type: 'POST',
            data: formData,
            processData: false, // Important!
            contentType: false, // Important!
            xhr: function() {
                var xhr = new window.XMLHttpRequest();
                // Upload progress event listener
                xhr.upload.addEventListener('progress', function(evt) {
                    if (evt.lengthComputable) {
                        var percentComplete = Math.round((evt.loaded / evt.total) * 100);
                        progressBar.css('width', percentComplete + '%');
                        progressBar.attr('aria-valuenow', percentComplete);
                        progressText.text(percentComplete + '%');
                    }
                }, false);
                return xhr;
            },
            success: function(data, textStatus, jqXHR) {
                // --- Upload Success ---
                progressBar.addClass('bg-success'); // Green bar on success
                statusMessage.text('Upload successful!').addClass('text-success').removeClass('text-danger');
                submitButton.html('<i class="fas fa-check"></i> Done!'); // Indicate success
                // Optionally close modal after a delay and refresh
                setTimeout(function() {
                     modal.modal('hide');
                     location.reload(); // Refresh page to see the new file
                }, 1500); // Close after 1.5 seconds
            },
            error: function(jqXHR, textStatus, errorThrown) {
                // --- Upload Error ---
                progressBar.addClass('bg-danger'); // Red bar on error
                var errorMessage = 'Upload failed. Please try again.';
                if (jqXHR.responseJSON && jqXHR.responseJSON.error) {
                    errorMessage = 'Upload failed: ' + jqXHR.responseJSON.error;
                } else if (errorThrown) {
                     errorMessage = 'Upload failed: ' + errorThrown;
                }
                statusMessage.text(errorMessage).addClass('text-danger').removeClass('text-success');

                // Re-enable form elements for another try
                submitButton.prop('disabled', false).html('<i class="fas fa-upload"></i> Upload');
                cancelButton.prop('disabled', false);
                closeButton.prop('disabled', false);
                fileInput.prop('disabled', false);
                folderSelect.prop('disabled', false);
                 // Make modal closable again
                modal.data('bs.modal')._config.backdrop = true;
                modal.data('bs.modal')._config.keyboard = true;
            }
            // No 'complete' needed as handled by success/error
        });
    });

});
</script>
{% endblock %}
